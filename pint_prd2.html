<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Roemer J. Janse">
<meta name="dcterms.date" content="2024-11-14">

<title>PINT - Prediction Practical 2</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./pint_prd1.html"> 
<span class="menu-text">Practical 1</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./pint_prd2.html" aria-current="page"> 
<span class="menu-text">Practical 2</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#preface" id="toc-preface" class="nav-link active" data-scroll-target="#preface"><span class="header-section-number">1</span> Preface</a></li>
  <li><a href="#introduction" id="toc-introduction" class="nav-link" data-scroll-target="#introduction"><span class="header-section-number">2</span> Introduction</a></li>
  <li><a href="#set-up" id="toc-set-up" class="nav-link" data-scroll-target="#set-up"><span class="header-section-number">3</span> Set-up</a>
  <ul class="collapse">
  <li><a href="#packages" id="toc-packages" class="nav-link" data-scroll-target="#packages"><span class="header-section-number">3.1</span> Packages</a></li>
  <li><a href="#loading-data" id="toc-loading-data" class="nav-link" data-scroll-target="#loading-data"><span class="header-section-number">3.2</span> Loading data</a></li>
  <li><a href="#preparing-our-data" id="toc-preparing-our-data" class="nav-link" data-scroll-target="#preparing-our-data"><span class="header-section-number">3.3</span> Preparing our data</a></li>
  <li><a href="#getting-to-know-our-data" id="toc-getting-to-know-our-data" class="nav-link" data-scroll-target="#getting-to-know-our-data"><span class="header-section-number">3.4</span> Getting to know our data</a></li>
  </ul></li>
  <li><a href="#ridge-lasso-and-elastic-net" id="toc-ridge-lasso-and-elastic-net" class="nav-link" data-scroll-target="#ridge-lasso-and-elastic-net"><span class="header-section-number">4</span> Ridge, LASSO, and elastic net</a>
  <ul class="collapse">
  <li><a href="#standard-model" id="toc-standard-model" class="nav-link" data-scroll-target="#standard-model"><span class="header-section-number">4.1</span> Standard model</a></li>
  <li><a href="#ridge-regression" id="toc-ridge-regression" class="nav-link" data-scroll-target="#ridge-regression"><span class="header-section-number">4.2</span> Ridge regression</a></li>
  <li><a href="#lasso-regression" id="toc-lasso-regression" class="nav-link" data-scroll-target="#lasso-regression"><span class="header-section-number">4.3</span> LASSO regression</a></li>
  <li><a href="#elastic-net-regression" id="toc-elastic-net-regression" class="nav-link" data-scroll-target="#elastic-net-regression"><span class="header-section-number">4.4</span> Elastic net regression</a></li>
  <li><a href="#performance" id="toc-performance" class="nav-link" data-scroll-target="#performance"><span class="header-section-number">4.5</span> Performance</a>
  <ul class="collapse">
  <li><a href="#set-up-for-calculating-validation-measures" id="toc-set-up-for-calculating-validation-measures" class="nav-link" data-scroll-target="#set-up-for-calculating-validation-measures"><span class="header-section-number">4.5.1</span> Set-up for calculating validation measures</a></li>
  <li><a href="#validate-models" id="toc-validate-models" class="nav-link" data-scroll-target="#validate-models"><span class="header-section-number">4.5.2</span> Validate models</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#bootstrap-based-uniform-shrinkage" id="toc-bootstrap-based-uniform-shrinkage" class="nav-link" data-scroll-target="#bootstrap-based-uniform-shrinkage"><span class="header-section-number">5</span> Bootstrap-based uniform shrinkage</a>
  <ul class="collapse">
  <li><a href="#development" id="toc-development" class="nav-link" data-scroll-target="#development"><span class="header-section-number">5.1</span> Development</a></li>
  <li><a href="#validation" id="toc-validation" class="nav-link" data-scroll-target="#validation"><span class="header-section-number">5.2</span> Validation</a></li>
  </ul></li>
  <li><a href="#final-words" id="toc-final-words" class="nav-link" data-scroll-target="#final-words"><span class="header-section-number">6</span> Final words</a></li>
  <li><a href="#postscript" id="toc-postscript" class="nav-link" data-scroll-target="#postscript"><span class="header-section-number">7</span> Postscript</a></li>
  </ul>
<div class="quarto-other-links"><h2>Other Links</h2><ul><li><a href="https://www.lumc.nl/en/afdelingen/Clinical-Epidemiology/epidemioloog-b/" target="_blank"><i class="bi bi-link-45deg"></i>EPI-B</a></li></ul></div><div class="quarto-code-links"><h2>Code Links</h2><ul><li><a href="https://github.com/rjjanse/practicals/blob/main/pint/pint_prd2.qmd"><i class="bi bi-file-code"></i>Source code</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">PINT - Prediction Practical 2</h1>
<p class="subtitle lead">Shrinkage Methods for Prediction Models</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Roemer J. Janse </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 14, 2024</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="preface" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Preface</h1>
<p>This R practical will discuss some shrinkage methods for prediction models in R. It assumes that you are aware of how prediction models are developed in R, as discussed in the <a href="https://rjjanse.github.io/practicals/pint_prd1">first practical</a>.</p>
</section>
<section id="introduction" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Introduction</h1>
<p>In this practical, we will see how to implement different shrinkage methods, specifically ridge regression, LASSO regression, and elastic net regression. Additionally, we will look at bootstrap-based uniform shrinkage (BU).</p>
<p>At the end of this practical, you will know how you can estimate the regularization parameter (<span class="math inline">\(\lambda\)</span>) and use it to perform these shrinkage-based regressions, as well as perform BU.</p>
</section>
<section id="set-up" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Set-up</h1>
<section id="packages" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="packages"><span class="header-section-number">3.1</span> Packages</h2>
<p>As usual, before we get going, we will load some useful packages.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="co"># Loading packages</span></span>
<span id="cb1-2"><a href="#cb1-2"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(<span class="st">"dplyr"</span>,         <span class="co"># Data wrangling</span></span>
<span id="cb1-3"><a href="#cb1-3"></a>               <span class="st">"magrittr"</span>,      <span class="co"># More efficient pipelines</span></span>
<span id="cb1-4"><a href="#cb1-4"></a>               <span class="st">"tidyr"</span>,         <span class="co"># Data tidying</span></span>
<span id="cb1-5"><a href="#cb1-5"></a>               <span class="st">"rio"</span>,           <span class="co"># Importing data</span></span>
<span id="cb1-6"><a href="#cb1-6"></a>               <span class="st">"glmnet"</span>,        <span class="co"># Shrinkage methods</span></span>
<span id="cb1-7"><a href="#cb1-7"></a>               <span class="st">"pROC"</span>,          <span class="co"># C-statistics</span></span>
<span id="cb1-8"><a href="#cb1-8"></a>               <span class="st">"knitr"</span>,         <span class="co"># Markdown functions</span></span>
<span id="cb1-9"><a href="#cb1-9"></a>               <span class="st">"ggplot2"</span>,       <span class="co"># Data visualization</span></span>
<span id="cb1-10"><a href="#cb1-10"></a>               <span class="st">"patchwork"</span>      <span class="co"># Patching plots together</span></span>
<span id="cb1-11"><a href="#cb1-11"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="loading-data" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="loading-data"><span class="header-section-number">3.2</span> Loading data</h2>
<p>For this practical, we will again use the Traumatic brain injury (TBI) data. This dataset contains 2,159 patients from the international and US Tirilazad trials (distributed here for didactic purposes only). The primary outcome was the Glasgow Outcome (range 1 through 5) at 6 months.</p>
<p>The TBI dataset was sent to you together with this practical and can be loaded from your local device:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="co"># Specify path of TBI dataset</span></span>
<span id="cb2-2"><a href="#cb2-2"></a>path <span class="ot">&lt;-</span> <span class="st">"C:/users/avid_PINT_student/documents/pint/TBI.txt"</span></span>
<span id="cb2-3"><a href="#cb2-3"></a></span>
<span id="cb2-4"><a href="#cb2-4"></a><span class="co"># Load TBI data</span></span>
<span id="cb2-5"><a href="#cb2-5"></a>tbi <span class="ot">&lt;-</span> <span class="fu">import</span>(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell">
<div class="cell-output cell-output-stderr">
<pre><code>Warning in (function (input = "", file = NULL, text = NULL, cmd = NULL, :
Detected 24 column names but the data has 25 columns (i.e. invalid file). Added
1 extra default column name for the first column which is guessed to be row
names or an index. Use setnames() afterwards if this guess is not correct, or
fix the file write command that created the file to create a valid file.</code></pre>
</div>
</div>
<p>The warning we receive is the result of row numbers being present in the .txt file (as also guessed by <code>import()</code>). Given that <code>import()</code> guessed correct, we can ignore this warning and treat the extra column V1 as individual identifiers.</p>
<p>Below is the codebook for the TBI data.</p>
<table class="table-striped table-hover table-sm small caption-top table">
<caption>Codebook for the TBI dataset</caption>
<colgroup>
<col style="width: 20%">
<col style="width: 56%">
<col style="width: 9%">
</colgroup>
<tbody>
<tr class="odd">
<td></td>
<td><strong>TBI</strong></td>
<td></td>
</tr>
<tr class="even">
<td><strong>Variable</strong></td>
<td><strong>Description</strong></td>
<td></td>
</tr>
<tr class="odd">
<td>V1</td>
<td>Identifier</td>
<td></td>
</tr>
<tr class="even">
<td>trial</td>
<td>Trial identification</td>
<td></td>
</tr>
<tr class="odd">
<td>d.gos</td>
<td><p>Glasgow Outcome Scale at 6 months</p>
<ol type="1">
<li>dead</li>
<li>vegetative</li>
<li>severe disability</li>
<li>moderate disability</li>
<li>good recovery</li>
</ol></td>
<td></td>
</tr>
<tr class="even">
<td>d.mort</td>
<td>Mortality at 6 months</td>
<td></td>
</tr>
<tr class="odd">
<td>d.unfav</td>
<td>Unfavourable outcome at 6 months</td>
<td></td>
</tr>
<tr class="even">
<td>cause</td>
<td><p>Cause of injury</p>
<ol start="3" type="1">
<li>road traffic accident</li>
<li>motorbike</li>
<li>assault</li>
<li>domestic/fall</li>
<li>other</li>
</ol></td>
<td></td>
</tr>
<tr class="odd">
<td>age</td>
<td>Age (<em>yrs</em>)</td>
<td></td>
</tr>
<tr class="even">
<td>d.motor</td>
<td>Admission motor score (range 1-6)</td>
<td></td>
</tr>
<tr class="odd">
<td>d.pupil</td>
<td><p>Pupillary reactivity</p>
<ol type="1">
<li>both reactive</li>
<li>one reactive</li>
<li>none reactive</li>
</ol></td>
<td></td>
</tr>
<tr class="even">
<td>pupil.i</td>
<td>Single imputed pupillary reactivity</td>
<td></td>
</tr>
<tr class="odd">
<td>hypoxia</td>
<td>Hypoxia before or at admission</td>
<td></td>
</tr>
<tr class="even">
<td>hypotens</td>
<td>Hypotension before or at admission</td>
<td></td>
</tr>
<tr class="odd">
<td>ctclass</td>
<td>Marshall CT classification (range 1-6)</td>
<td></td>
</tr>
<tr class="even">
<td>tsah</td>
<td>tSAH at CT</td>
<td></td>
</tr>
<tr class="odd">
<td>edh</td>
<td>EDH at CT</td>
<td></td>
</tr>
<tr class="even">
<td>cisterns</td>
<td><p>Compressed cisterns at CT</p>
<ol start="0" type="1">
<li>no</li>
<li>slightly</li>
<li>fully</li>
</ol></td>
<td></td>
</tr>
<tr class="odd">
<td>shift</td>
<td>Midline shift &gt;5 mm at CT</td>
<td></td>
</tr>
<tr class="even">
<td>d.sysbpt</td>
<td colspan="2">Systolic blood pressure at admission (<em>mmHg</em>)</td>
</tr>
<tr class="odd">
<td>glucose</td>
<td>Glucose at admission (<em>mmol/L</em>)</td>
<td></td>
</tr>
<tr class="even">
<td>glucoset</td>
<td>Truncated glucose values (<em>mmol/L</em>)</td>
<td></td>
</tr>
<tr class="odd">
<td>ph</td>
<td>pH</td>
<td></td>
</tr>
<tr class="even">
<td>sodium</td>
<td>Sodium (<em>mmol/L</em>)</td>
<td></td>
</tr>
<tr class="odd">
<td>hb</td>
<td>Hemoglobin (<em>g/dL</em>)</td>
<td></td>
</tr>
<tr class="even">
<td>hbt</td>
<td>Truncated hemoglobin (<em>g/dL</em>)</td>
<td></td>
</tr>
</tbody>
</table>
</section>
<section id="preparing-our-data" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="preparing-our-data"><span class="header-section-number">3.3</span> Preparing our data</h2>
<p>Like last time, we will develop a prediction model for the risk of an unfavourable outcome after a TBI. However, we will geographically split the data into a development dataset (individuals from the Tirilazad US trial) and a validation dataset (individuals from the Tirilazad International trial). Additionally, although not recommended, for educational simplicity, we have again used single imputation for missing data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="co"># Prior to split, set categorical variables to factors</span></span>
<span id="cb4-2"><a href="#cb4-2"></a>tbi <span class="sc">%&lt;&gt;%</span> <span class="fu">mutate</span>(<span class="fu">across</span>(<span class="fu">c</span>(pupil.i, cause), as.factor))</span>
<span id="cb4-3"><a href="#cb4-3"></a></span>
<span id="cb4-4"><a href="#cb4-4"></a><span class="co"># Create development dataset</span></span>
<span id="cb4-5"><a href="#cb4-5"></a>development <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbi, trial <span class="sc">==</span> <span class="st">"Tirilazad US"</span>)</span>
<span id="cb4-6"><a href="#cb4-6"></a></span>
<span id="cb4-7"><a href="#cb4-7"></a><span class="co"># Create validation dataset</span></span>
<span id="cb4-8"><a href="#cb4-8"></a>validation <span class="ot">&lt;-</span> <span class="fu">filter</span>(tbi, trial <span class="sc">==</span> <span class="st">"Tirilazad International"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="getting-to-know-our-data" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="getting-to-know-our-data"><span class="header-section-number">3.4</span> Getting to know our data</h2>
<p>To get to know our data, we will look at the number of cases in both datasets.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="co"># Counts of non-cases and cases</span></span>
<span id="cb5-2"><a href="#cb5-2"></a><span class="fu">by</span>(tbi[[<span class="st">"d.unfav"</span>]], tbi[[<span class="st">"trial"</span>]], table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tbi[["trial"]]: Tirilazad International

  0   1 
662 456 
------------------------------------------------------------ 
tbi[["trial"]]: Tirilazad US

  0   1 
646 395 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="co"># Distribution of non-cases and cases (as %)</span></span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="fu">by</span>(tbi[[<span class="st">"d.unfav"</span>]], tbi[[<span class="st">"trial"</span>]], \(x) <span class="fu">proportions</span>(<span class="fu">table</span>(x)) <span class="sc">*</span> <span class="dv">100</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tbi[["trial"]]: Tirilazad International
x
       0        1 
59.21288 40.78712 
------------------------------------------------------------ 
tbi[["trial"]]: Tirilazad US
x
       0        1 
62.05572 37.94428 </code></pre>
</div>
</div>
<p>In the development dataset, we can see that we have quite some cases (n = 395, 37.9%). We have a bit more in the validation dataset (n = 456, 40.8%).</p>
<p>We (hypothetically) consulted the same TBI experts as last time, who told us that the most important predictors we want to include are pupillary reactivity (‘pupil.i’), TBI cause (‘cause’), systolic blood pressure (d.sysbpt), and age (‘age’). They do not mention motor activity anymore due to recent research of them. This would mean that there are a total of 8 candidate coefficients. If we were to calculate an events-per-variable (EPV), this would be:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1"></a><span class="co"># EPV in both datasets</span></span>
<span id="cb9-2"><a href="#cb9-2"></a><span class="fu">by</span>(tbi[[<span class="st">"d.unfav"</span>]], tbi[[<span class="st">"trial"</span>]], \(x) <span class="fu">table</span>(x)[[<span class="st">"1"</span>]] <span class="sc">/</span> <span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tbi[["trial"]]: Tirilazad International
[1] 57
------------------------------------------------------------ 
tbi[["trial"]]: Tirilazad US
[1] 49.375</code></pre>
</div>
</div>
<p>This is not bad, but EPV is also not an ideal measure. More formal sample size calculations <a href="https://doi.org/10.1002/sim.7992">are available</a> but are outside the scope of this course.</p>
<p>Last time, we already saw that even though age is continuous, a linear term is sufficient to include it in the model. We also checked this for systolic blood pressure, which was also linear.</p>
</section>
</section>
<section id="ridge-lasso-and-elastic-net" class="level1 page-columns page-full" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Ridge, LASSO, and elastic net</h1>
<section id="standard-model" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="standard-model"><span class="header-section-number">4.1</span> Standard model</h2>
<p>To show how shrinkage affects the model, we will first develop a standard logistic prediction model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1"></a><span class="co"># Develop the prediction model</span></span>
<span id="cb11-2"><a href="#cb11-2"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(d.unfav <span class="sc">~</span>                                        </span>
<span id="cb11-3"><a href="#cb11-3"></a>               age <span class="sc">+</span>     </span>
<span id="cb11-4"><a href="#cb11-4"></a>               d.sysbpt <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5"></a>               pupil.i <span class="sc">+</span></span>
<span id="cb11-6"><a href="#cb11-6"></a>               cause, </span>
<span id="cb11-7"><a href="#cb11-7"></a>           <span class="at">data =</span> development, <span class="at">family =</span> binomial)     </span>
<span id="cb11-8"><a href="#cb11-8"></a></span>
<span id="cb11-9"><a href="#cb11-9"></a><span class="co"># See output</span></span>
<span id="cb11-10"><a href="#cb11-10"></a><span class="fu">summary</span>(fit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Call:
glm(formula = d.unfav ~ age + d.sysbpt + pupil.i + cause, family = binomial, 
    data = development)

Coefficients:
                            Estimate Std. Error z value Pr(&gt;|z|)    
(Intercept)                -1.382712   0.698858  -1.979   0.0479 *  
age                         0.037291   0.005986   6.230 4.68e-10 ***
d.sysbpt                   -0.008379   0.004562  -1.836   0.0663 .  
pupil.ino reactive pupils   1.836702   0.176985  10.378  &lt; 2e-16 ***
pupil.ione reactive         0.834370   0.206248   4.045 5.22e-05 ***
causedomestic/fall          0.296242   0.293463   1.009   0.3128    
causeMotorbike             -0.019630   0.309420  -0.063   0.9494    
causeother                  0.483429   0.283144   1.707   0.0878 .  
causeRoad traffic accident  0.266325   0.257151   1.036   0.3004    
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

(Dispersion parameter for binomial family taken to be 1)

    Null deviance: 1382.0  on 1040  degrees of freedom
Residual deviance: 1200.2  on 1032  degrees of freedom
AIC: 1218.2

Number of Fisher Scoring iterations: 4</code></pre>
</div>
</div>
</section>
<section id="ridge-regression" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="ridge-regression"><span class="header-section-number">4.2</span> Ridge regression</h2>
<p>Ridge regression, also known as <span class="math inline">\(l_2\)</span> regularization, applies a penalty to the maximum likelihood estimator, leading to shrinkage of the regression coefficients, which results in a less optimistic model. In the below formula, the white part shows the maximum likelihood estimator of a logsitic model and the red part the addition of the <span class="math inline">\(l_2\)</span> regularization:</p>
<p><span class="math display">\[
\log{L} = \sum_iy_i\log{\pi_i}+(1-y_i)\log{(1-\pi_i)}-\color{blue}{\lambda\sum_{j=1}^P\hat{\beta}_j^2}
\]</span></p>
<p>where <span class="math inline">\(i\)</span> stands for individual <span class="math inline">\(i\)</span>, <span class="math inline">\(y_i\)</span> is the observed outcome for individual <span class="math inline">\(i\)</span> and <span class="math inline">\(\pi_i\)</span> is the predicted outcome for individual i.</p>
<p>We can fit a ridge regression using <code>glmnet()</code> from the <code>{glmnet}</code> package. However, first we require a value for <span class="math inline">\(\lambda\)</span>. The preferred way to determine this is by <span class="math inline">\(k\)</span>-fold cross-validation, as implemented in the function <code>cv.glmnet()</code>from <code>{glmnet}</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-8-1" class="code-annotation-target"><a href="#annotated-cell-8-1"></a><span class="co"># Prepare predictors</span></span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2"></a>x <span class="ot">&lt;-</span> development <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3"></a>    <span class="co"># Select predictors</span></span>
<span id="annotated-cell-8-4"><a href="#annotated-cell-8-4"></a>    <span class="fu">select</span>(age, d.sysbpt, pupil.i, cause) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5"></a>    <span class="co"># Change to matrix</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-8-6" class="code-annotation-target"><a href="#annotated-cell-8-6"></a>    <span class="fu">model.matrix</span>(<span class="sc">~</span> age <span class="sc">+</span> d.sysbpt <span class="sc">+</span> pupil.i <span class="sc">+</span> cause, <span class="at">data =</span> .)</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7"></a></span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8"></a><span class="co"># Remove intercept column from x (makes output easier to read)</span></span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9"></a>x <span class="ot">&lt;-</span> x[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="annotated-cell-8-10"><a href="#annotated-cell-8-10"></a>    </span>
<span id="annotated-cell-8-11"><a href="#annotated-cell-8-11"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-8-12" class="code-annotation-target"><a href="#annotated-cell-8-12"></a><span class="co"># Prepare outcome</span></span>
<span id="annotated-cell-8-13"><a href="#annotated-cell-8-13"></a>y <span class="ot">&lt;-</span> development <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-14"><a href="#annotated-cell-8-14"></a>    <span class="co"># Select outcome</span></span>
<span id="annotated-cell-8-15"><a href="#annotated-cell-8-15"></a>    <span class="fu">select</span>(d.unfav) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-8-16"><a href="#annotated-cell-8-16"></a>    <span class="co"># Change to matrix</span></span>
<span id="annotated-cell-8-17"><a href="#annotated-cell-8-17"></a>    <span class="fu">as.matrix</span>()</span>
<span id="annotated-cell-8-18"><a href="#annotated-cell-8-18"></a></span>
<span id="annotated-cell-8-19"><a href="#annotated-cell-8-19"></a><span class="co"># Run cross-validation</span></span>
<span id="annotated-cell-8-20"><a href="#annotated-cell-8-20"></a>cv_ridge <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> x, </span>
<span id="annotated-cell-8-21"><a href="#annotated-cell-8-21"></a>                      <span class="at">y =</span> y, </span>
<span id="annotated-cell-8-22"><a href="#annotated-cell-8-22"></a>                      <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="annotated-cell-8-23"><a href="#annotated-cell-8-23"></a>                      <span class="at">type.measure =</span> <span class="st">"mse"</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-8-24" class="code-annotation-target"><a href="#annotated-cell-8-24"></a>                      <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-8-25" class="code-annotation-target"><a href="#annotated-cell-8-25"></a>                      <span class="at">nfolds =</span> <span class="dv">10</span>)</span>
<span id="annotated-cell-8-26"><a href="#annotated-cell-8-26"></a></span>
<span id="annotated-cell-8-27"><a href="#annotated-cell-8-27"></a><span class="co"># Get optimal lambda</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-8-28" class="code-annotation-target"><a href="#annotated-cell-8-28"></a>(lambda <span class="ot">&lt;-</span> cv_ridge[[<span class="st">"lambda.min"</span>]])</span>
<span id="annotated-cell-8-29"><a href="#annotated-cell-8-29"></a></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-8-30" class="code-annotation-target"><a href="#annotated-cell-8-30"></a><span class="co"># Show results of cross-validation</span></span>
<span id="annotated-cell-8-31"><a href="#annotated-cell-8-31"></a><span class="fu">ggplot</span>(<span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">log</span>(cv_ridge[[<span class="st">"lambda"</span>]]), <span class="at">y =</span> cv_ridge[[<span class="st">"cvm"</span>]], </span>
<span id="annotated-cell-8-32"><a href="#annotated-cell-8-32"></a>                     <span class="at">ymin =</span> cv_ridge[[<span class="st">"cvlo"</span>]], <span class="at">ymax =</span> cv_ridge[[<span class="st">"cvup"</span>]])) <span class="sc">+</span></span>
<span id="annotated-cell-8-33"><a href="#annotated-cell-8-33"></a>    <span class="co"># Geometries</span></span>
<span id="annotated-cell-8-34"><a href="#annotated-cell-8-34"></a>    <span class="fu">geom_point</span>(<span class="at">colour =</span> <span class="st">"#785EF0"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-8-35"><a href="#annotated-cell-8-35"></a>    <span class="fu">geom_errorbar</span>(<span class="at">width =</span> <span class="fl">0.2</span>, <span class="at">colour =</span> <span class="st">"#785EF0"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-8-36"><a href="#annotated-cell-8-36"></a>    <span class="fu">geom_vline</span>(<span class="at">xintercept =</span> <span class="fu">log</span>(lambda), <span class="at">alpha =</span> <span class="fl">0.3</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-8-37"><a href="#annotated-cell-8-37"></a>    <span class="co"># Labels</span></span>
<span id="annotated-cell-8-38"><a href="#annotated-cell-8-38"></a>    <span class="fu">xlab</span>(<span class="fu">expression</span>(<span class="fu">log</span>(lambda))) <span class="sc">+</span> </span>
<span id="annotated-cell-8-39"><a href="#annotated-cell-8-39"></a>    <span class="fu">ylab</span>(<span class="st">"Mean squared error"</span>) <span class="sc">+</span></span>
<span id="annotated-cell-8-40"><a href="#annotated-cell-8-40"></a>    <span class="co"># Aesthetics</span></span>
<span id="annotated-cell-8-41"><a href="#annotated-cell-8-41"></a>    <span class="fu">theme_bw</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="1" data-code-annotation="1">The function <code>cv.glmnet()</code> requires a matrix with the predictors, where each row corresponds to an observation and each column a predictor.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="6" data-code-annotation="2">Factors are not allowed in the x matrix, which means that we should already create dummy variables for the factors. The function <code>model.matrix()</code> does this for us.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="12" data-code-annotation="3">The outcome should also be given as a matrix or vector.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="24" data-code-annotation="4">We specify <code>alpha = 0</code> to indicate that we want to use ridge regression. If we use <code>alpha = 1</code>, we indicate LASSO regression. Anything in between would result in elastic net regression.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="25" data-code-annotation="5">We specify 10-fold cross-validation.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="28" data-code-annotation="6">The optimal <span class="math inline">\(\lambda\)</span> is derived by taking <code>lambda.min</code> from the results.</span>
</dd>
<dt data-target-cell="annotated-cell-8" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="30" data-code-annotation="7">We can show that the <span class="math inline">\(\lambda\)</span> we selected (the dashed line) is the one with the lowest mean squared error. The x-axis is in log scale for clarity.</span>
</dd>
</dl>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pint_prd2_files/figure-html/unnamed-chunk-7-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.01576116</code></pre>
</div>
</div>
<p>Now we can fit our ridge regression model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a><span class="co"># Fit ridge regression</span></span>
<span id="cb14-2"><a href="#cb14-2"></a>fit_ridge <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x,</span>
<span id="cb14-3"><a href="#cb14-3"></a>                    <span class="at">y =</span> y,</span>
<span id="cb14-4"><a href="#cb14-4"></a>                    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb14-5"><a href="#cb14-5"></a>                    <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb14-6"><a href="#cb14-6"></a>                    <span class="at">lambda =</span> lambda)</span>
<span id="cb14-7"><a href="#cb14-7"></a>                    </span>
<span id="cb14-8"><a href="#cb14-8"></a><span class="co"># Compare coefficients</span></span>
<span id="cb14-9"><a href="#cb14-9"></a><span class="fu">data.frame</span>(<span class="at">standard =</span> fit[[<span class="st">"coefficients"</span>]],</span>
<span id="cb14-10"><a href="#cb14-10"></a>           <span class="at">ridge =</span> <span class="fu">coef</span>(fit_ridge)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               standard        ridge
(Intercept)                -1.382712131 -1.175577461
age                         0.037291271  0.033647308
d.sysbpt                   -0.008378515 -0.007997321
pupil.ino reactive pupils   1.836702419  1.681658780
pupil.ione reactive         0.834370082  0.747330320
causedomestic/fall          0.296242006  0.216124849
causeMotorbike             -0.019630030 -0.105348530
causeother                  0.483428921  0.370953923
causeRoad traffic accident  0.266325399  0.163070376</code></pre>
</div>
</div>
<p>Comparing these coefficients to the standard model, we may observe that the coefficients are shrunk. If you have a polychotomous predictor, not all coefficients for that predictor might shrink.</p>
<p>If we set <span class="math inline">\(\lambda\)</span> to 0, we can see that it will be the same as the standard logistic regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a><span class="co"># Fit ridge regression with lambda 0</span></span>
<span id="cb16-2"><a href="#cb16-2"></a>fit_glmnet <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x,</span>
<span id="cb16-3"><a href="#cb16-3"></a>                     <span class="at">y =</span> y,</span>
<span id="cb16-4"><a href="#cb16-4"></a>                     <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb16-5"><a href="#cb16-5"></a>                     <span class="at">alpha =</span> <span class="dv">0</span>,</span>
<span id="cb16-6"><a href="#cb16-6"></a>                     <span class="at">lambda =</span> <span class="dv">0</span>)</span>
<span id="cb16-7"><a href="#cb16-7"></a></span>
<span id="cb16-8"><a href="#cb16-8"></a><span class="co"># Compare coefficients</span></span>
<span id="cb16-9"><a href="#cb16-9"></a><span class="fu">data.frame</span>(<span class="at">glm =</span> fit[[<span class="st">"coefficients"</span>]],</span>
<span id="cb16-10"><a href="#cb16-10"></a>           <span class="at">glmnet =</span> <span class="fu">coef</span>(fit_glmnet)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                    glm      glmnet
(Intercept)                -1.382712131 -1.38090517
age                         0.037291271  0.03729148
d.sysbpt                   -0.008378515 -0.00838120
pupil.ino reactive pupils   1.836702419  1.83677107
pupil.ione reactive         0.834370082  0.83440811
causedomestic/fall          0.296242006  0.29438080
causeMotorbike             -0.019630030 -0.02141978
causeother                  0.483428921  0.48173948
causeRoad traffic accident  0.266325399  0.26484164</code></pre>
</div>
</div>
</section>
<section id="lasso-regression" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="lasso-regression"><span class="header-section-number">4.3</span> LASSO regression</h2>
<p>The least absolute shrinkage and selection operator (LASSO) regression functions similar to ridge regression, except that it is able to shrink coefficients to 0, leading to removal of those predictors from the prediction model. It applies the <span class="math inline">\(l_1\)</span> penalty and is expressed as:</p>
<p><span class="math display">\[
\log{L} = \sum_iy_i\log{\pi_i}+(1-y_i)\log{(1-\pi_i)}-\color{red}{\lambda\sum_{j=1}^{P}\lvert\hat{\beta}_j\lvert}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1"></a><span class="co"># Run cross-validation</span></span>
<span id="annotated-cell-11-2"><a href="#annotated-cell-11-2"></a>cv_ridge <span class="ot">&lt;-</span> <span class="fu">cv.glmnet</span>(<span class="at">x =</span> x, </span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3"></a>                      <span class="at">y =</span> y, </span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4"></a>                      <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="annotated-cell-11-5"><a href="#annotated-cell-11-5"></a>                      <span class="at">type.measure =</span> <span class="st">"mse"</span>,</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-11-6" class="code-annotation-target"><a href="#annotated-cell-11-6"></a>                      <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7"></a>                      <span class="at">nfolds =</span> <span class="dv">10</span>) </span>
<span id="annotated-cell-11-8"><a href="#annotated-cell-11-8"></a></span>
<span id="annotated-cell-11-9"><a href="#annotated-cell-11-9"></a><span class="co"># Get optimal lambda</span></span>
<span id="annotated-cell-11-10"><a href="#annotated-cell-11-10"></a>(lambda <span class="ot">&lt;-</span> cv_ridge[[<span class="st">"lambda.min"</span>]])         </span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="6" data-code-annotation="1">Now we specify <code>alpha = 1</code>, indicating LASSO regression.</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.006665778</code></pre>
</div>
</div>
<p>Using our newly estimated <span class="math inline">\(\lambda\)</span>, we can fit a LASSO regression:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="co"># Fit LASSO regression</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>fit_lasso <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x,</span>
<span id="cb19-3"><a href="#cb19-3"></a>                    <span class="at">y =</span> y,</span>
<span id="cb19-4"><a href="#cb19-4"></a>                    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb19-5"><a href="#cb19-5"></a>                    <span class="at">alpha =</span> <span class="dv">1</span>,</span>
<span id="cb19-6"><a href="#cb19-6"></a>                    <span class="at">lambda =</span> lambda)</span>
<span id="cb19-7"><a href="#cb19-7"></a>                    </span>
<span id="cb19-8"><a href="#cb19-8"></a><span class="co"># Compare coefficients</span></span>
<span id="cb19-9"><a href="#cb19-9"></a><span class="fu">data.frame</span>(<span class="at">standard =</span> fit[[<span class="st">"coefficients"</span>]],</span>
<span id="cb19-10"><a href="#cb19-10"></a>           <span class="at">lasso =</span> <span class="fu">coef</span>(fit_lasso)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               standard        lasso
(Intercept)                -1.382712131 -1.205625924
age                         0.037291271  0.034164901
d.sysbpt                   -0.008378515 -0.006832488
pupil.ino reactive pupils   1.836702419  1.733699634
pupil.ione reactive         0.834370082  0.724259016
causedomestic/fall          0.296242006  0.000000000
causeMotorbike             -0.019630030 -0.172487223
causeother                  0.483428921  0.175147432
causeRoad traffic accident  0.266325399  0.000000000</code></pre>
</div>
</div>
<p>From this output, we can see that two levels of cause were set to 0, effectively removing those variables from the final prediction model.</p>
</section>
<section id="elastic-net-regression" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="elastic-net-regression"><span class="header-section-number">4.4</span> Elastic net regression</h2>
<p>A special case is elastic net regression, where we combine the <span class="math inline">\(l_1\)</span> and <span class="math inline">\(l_2\)</span> penalties, or in other words blend ridge and LASSO regression. This takes the advantages of both approaches. A logistic elastic net model is expressed as</p>
<p><span class="math display">\[
\log{L} = \sum_iy_i\log{\pi_i}+(1-y_i)\log{(1-\pi_i)}-
\color{green}{\lambda}\left(
\color{red}{\alpha\sum_{j=1}^{P}\lvert\hat{\beta}_j\lvert}+
\color{blue}{\frac{1-\alpha}{2}\lambda\sum_{p=1}^P\hat{\beta}_p^2}\right)
\]</span></p>
<p>We can see that <span class="math inline">\(\lambda\)</span> applies to both penalties at the same time and that <span class="math inline">\(\alpha\)</span> determines to what extent each penalty is applied. For instance, we can perform an elastic net regression with an alpha of 0.5 as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a><span class="co"># Fit LASSO regression</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>fit_elnet <span class="ot">&lt;-</span> <span class="fu">glmnet</span>(<span class="at">x =</span> x,</span>
<span id="cb21-3"><a href="#cb21-3"></a>                    <span class="at">y =</span> y,</span>
<span id="cb21-4"><a href="#cb21-4"></a>                    <span class="at">family =</span> <span class="st">"binomial"</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>                    <span class="at">alpha =</span> <span class="fl">0.5</span>,</span>
<span id="cb21-6"><a href="#cb21-6"></a>                    <span class="at">lambda =</span> lambda)</span>
<span id="cb21-7"><a href="#cb21-7"></a>                    </span>
<span id="cb21-8"><a href="#cb21-8"></a><span class="co"># Compare coefficients</span></span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="fu">data.frame</span>(<span class="at">standard =</span> fit[[<span class="st">"coefficients"</span>]],</span>
<span id="cb21-10"><a href="#cb21-10"></a>           <span class="st">`</span><span class="at">elastic net</span><span class="st">`</span> <span class="ot">=</span> <span class="fu">coef</span>(fit_elnet)[<span class="dv">1</span><span class="sc">:</span><span class="dv">9</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               standard  elastic.net
(Intercept)                -1.382712131 -1.209473918
age                         0.037291271  0.034777340
d.sysbpt                   -0.008378515 -0.007578833
pupil.ino reactive pupils   1.836702419  1.751092692
pupil.ione reactive         0.834370082  0.761231615
causedomestic/fall          0.296242006  0.105928816
causeMotorbike             -0.019630030 -0.140934396
causeother                  0.483428921  0.279230861
causeRoad traffic accident  0.266325399  0.077015633</code></pre>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>Note that for ridge regression, LASSO regression, and elastic net regression, we need to estimate separate <span class="math inline">\(\lambda\)</span>’s.</p>
</div>
</div>
</section>
<section id="performance" class="level2 page-columns page-full" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="performance"><span class="header-section-number">4.5</span> Performance</h2>
<section id="set-up-for-calculating-validation-measures" class="level3 page-columns page-full" data-number="4.5.1">
<h3 data-number="4.5.1" class="anchored" data-anchor-id="set-up-for-calculating-validation-measures"><span class="header-section-number">4.5.1</span> Set-up for calculating validation measures</h3>
<p>Now that we fit our standard and shrunk models, we can see how they compare in performance, especially in an external validation set.</p>
<p>We will first create a function to calculate the C-statistic for our models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a><span class="co"># Function to calculate C-statistic for output of a glmnet</span></span>
<span id="cb23-2"><a href="#cb23-2"></a>cstat <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, x, y, df){</span>
<span id="cb23-3"><a href="#cb23-3"></a>    <span class="co"># Calculate predictions for glmnet output</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>    <span class="cf">if</span>(<span class="st">"glmnet"</span> <span class="sc">%in%</span> <span class="fu">class</span>(fit)) preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> x, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a>    </span>
<span id="cb23-6"><a href="#cb23-6"></a>    <span class="co"># Calculate predictions for glm output</span></span>
<span id="cb23-7"><a href="#cb23-7"></a>    <span class="cf">else</span> preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> df, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb23-8"><a href="#cb23-8"></a>    </span>
<span id="cb23-9"><a href="#cb23-9"></a>    <span class="co"># Calculate C-statistic</span></span>
<span id="cb23-10"><a href="#cb23-10"></a>    cst <span class="ot">&lt;-</span> <span class="fu">roc</span>(<span class="fu">as.numeric</span>(y), <span class="fu">as.numeric</span>(preds), <span class="at">levels =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">direction =</span> <span class="st">"&lt;"</span>)</span>
<span id="cb23-11"><a href="#cb23-11"></a>    </span>
<span id="cb23-12"><a href="#cb23-12"></a>    <span class="co"># Return c-statistic</span></span>
<span id="cb23-13"><a href="#cb23-13"></a>    <span class="fu">return</span>(cst[[<span class="st">"auc"</span>]][[<span class="dv">1</span>]])</span>
<span id="cb23-14"><a href="#cb23-14"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>

<div class="no-row-height column-margin column-container"><div class="">
<p>We do not need to create these functions. However, to keep our script legible and more efficient, we pooled together the calculation of C-statistics for glm and glmnet objects. Simply, it calculates the predictions based on whether the model was fitted using <code>glm()</code> or <code>glmnet()</code> and then uses the <code>roc()</code> function from <code>{pROC}</code> to calculate the C-statistic and return it.</p>
</div></div><p>We will also need to create the x and y matrices of the validation data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy"><code class="sourceCode r"><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1"></a><span class="co"># Prepare predictors                            </span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2"></a>x_val <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3"></a>    <span class="co"># Select predictors</span></span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4"></a>    <span class="fu">select</span>(age, d.sysbpt, pupil.i, cause) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5"></a>    <span class="co"># Change to matrix</span></span>
<span id="annotated-cell-15-6"><a href="#annotated-cell-15-6"></a>    <span class="fu">model.matrix</span>(<span class="sc">~</span> age <span class="sc">+</span> d.sysbpt <span class="sc">+</span> pupil.i <span class="sc">+</span> cause, <span class="at">data =</span> .)</span>
<span id="annotated-cell-15-7"><a href="#annotated-cell-15-7"></a></span>
<span id="annotated-cell-15-8"><a href="#annotated-cell-15-8"></a><span class="co"># Remove intercept column from x (makes output easier to read)</span></span>
<span id="annotated-cell-15-9"><a href="#annotated-cell-15-9"></a>x_val <span class="ot">&lt;-</span> x_val[, <span class="sc">-</span><span class="dv">1</span>]</span>
<span id="annotated-cell-15-10"><a href="#annotated-cell-15-10"></a>    </span>
<span id="annotated-cell-15-11"><a href="#annotated-cell-15-11"></a><span class="co"># Prepare outcome                                </span></span>
<span id="annotated-cell-15-12"><a href="#annotated-cell-15-12"></a>y_val <span class="ot">&lt;-</span> validation <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-15-13"><a href="#annotated-cell-15-13"></a>    <span class="co"># Select outcome</span></span>
<span id="annotated-cell-15-14"><a href="#annotated-cell-15-14"></a>    <span class="fu">select</span>(d.unfav) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-15-15"><a href="#annotated-cell-15-15"></a>    <span class="co"># Change to matrix</span></span>
<span id="annotated-cell-15-16"><a href="#annotated-cell-15-16"></a>    <span class="fu">as.matrix</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Moreover, we will create a function to calculate the calibration intercept and slope for all models:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a><span class="co"># Function to calculate calibration metrics</span></span>
<span id="cb24-2"><a href="#cb24-2"></a>calmetrics <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, <span class="at">x =</span> <span class="cn">NULL</span>, <span class="at">y =</span> <span class="cn">NULL</span>, <span class="at">df =</span> <span class="cn">NULL</span>){</span>
<span id="cb24-3"><a href="#cb24-3"></a>    <span class="co"># Calculate predictions for glmnet output</span></span>
<span id="cb24-4"><a href="#cb24-4"></a>    <span class="cf">if</span>(<span class="st">"glmnet"</span> <span class="sc">%in%</span> <span class="fu">class</span>(fit)) preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> x)</span>
<span id="cb24-5"><a href="#cb24-5"></a>    </span>
<span id="cb24-6"><a href="#cb24-6"></a>    <span class="co"># Calculate predictions for glm output</span></span>
<span id="cb24-7"><a href="#cb24-7"></a>    <span class="cf">else</span> preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> df)</span>
<span id="cb24-8"><a href="#cb24-8"></a>    </span>
<span id="cb24-9"><a href="#cb24-9"></a>    <span class="co"># Calculate calibration</span></span>
<span id="cb24-10"><a href="#cb24-10"></a>    fit_cal <span class="ot">&lt;-</span> <span class="fu">glm</span>(y <span class="sc">~</span> preds, <span class="at">family =</span> binomial)</span>
<span id="cb24-11"><a href="#cb24-11"></a>    </span>
<span id="cb24-12"><a href="#cb24-12"></a>    <span class="co"># Get intercept and slope</span></span>
<span id="cb24-13"><a href="#cb24-13"></a>    results <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">intercept =</span> <span class="fu">round</span>(fit_cal[[<span class="st">"coefficients"</span>]][[<span class="dv">1</span>]], <span class="dv">3</span>),</span>
<span id="cb24-14"><a href="#cb24-14"></a>                    <span class="at">slope =</span> <span class="fu">round</span>(fit_cal[[<span class="st">"coefficients"</span>]][[<span class="dv">2</span>]], <span class="dv">3</span>))</span>
<span id="cb24-15"><a href="#cb24-15"></a>    </span>
<span id="cb24-16"><a href="#cb24-16"></a>    <span class="co"># Return results</span></span>
<span id="cb24-17"><a href="#cb24-17"></a>    <span class="fu">return</span>(results)</span>
<span id="cb24-18"><a href="#cb24-18"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The last thing we will do is putting all predictions in a single data frame to draw our calibration plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1"></a><span class="co"># Function to calculate predictions</span></span>
<span id="cb25-2"><a href="#cb25-2"></a>preds <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, x, y, df){</span>
<span id="cb25-3"><a href="#cb25-3"></a>    <span class="co"># Calculate predictions for glmnet output</span></span>
<span id="cb25-4"><a href="#cb25-4"></a>    <span class="cf">if</span>(<span class="st">"glmnet"</span> <span class="sc">%in%</span> <span class="fu">class</span>(fit)) preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newx =</span> x, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb25-5"><a href="#cb25-5"></a>    </span>
<span id="cb25-6"><a href="#cb25-6"></a>    <span class="co"># Calculate predictions for glm output</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>    <span class="cf">else</span> preds <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> df, <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb25-8"><a href="#cb25-8"></a>    </span>
<span id="cb25-9"><a href="#cb25-9"></a>    <span class="co"># Return predictions</span></span>
<span id="cb25-10"><a href="#cb25-10"></a>    <span class="fu">return</span>(preds)</span>
<span id="cb25-11"><a href="#cb25-11"></a>}</span>
<span id="cb25-12"><a href="#cb25-12"></a></span>
<span id="cb25-13"><a href="#cb25-13"></a><span class="do">## Create data for each model</span></span>
<span id="cb25-14"><a href="#cb25-14"></a><span class="co"># Standard model</span></span>
<span id="cb25-15"><a href="#cb25-15"></a>dat_standard <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Development"</span>, <span class="fu">nrow</span>(development)), <span class="fu">rep</span>(<span class="st">"Validation"</span>, <span class="fu">nrow</span>(validation))),</span>
<span id="cb25-16"><a href="#cb25-16"></a>                       <span class="at">preds =</span> <span class="fu">c</span>(<span class="fu">preds</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development), <span class="fu">preds</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)),</span>
<span id="cb25-17"><a href="#cb25-17"></a>                       <span class="at">obs =</span> <span class="fu">c</span>(y, y_val)) <span class="sc">%&gt;%</span></span>
<span id="cb25-18"><a href="#cb25-18"></a>    <span class="co"># Add indicator</span></span>
<span id="cb25-19"><a href="#cb25-19"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Standard"</span>)</span>
<span id="cb25-20"><a href="#cb25-20"></a></span>
<span id="cb25-21"><a href="#cb25-21"></a><span class="co"># Ridge model</span></span>
<span id="cb25-22"><a href="#cb25-22"></a>dat_ridge <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Development"</span>, <span class="fu">nrow</span>(development)), <span class="fu">rep</span>(<span class="st">"Validation"</span>, <span class="fu">nrow</span>(validation))),</span>
<span id="cb25-23"><a href="#cb25-23"></a>                    <span class="at">preds =</span> <span class="fu">c</span>(<span class="fu">preds</span>(fit_ridge, x, y), <span class="fu">preds</span>(fit_ridge, x_val, y_val)),</span>
<span id="cb25-24"><a href="#cb25-24"></a>                    <span class="at">obs =</span> <span class="fu">c</span>(y, y_val))<span class="sc">%&gt;%</span></span>
<span id="cb25-25"><a href="#cb25-25"></a>    <span class="co"># Add indicator</span></span>
<span id="cb25-26"><a href="#cb25-26"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Ridge"</span>)</span>
<span id="cb25-27"><a href="#cb25-27"></a></span>
<span id="cb25-28"><a href="#cb25-28"></a><span class="co"># LASSO model</span></span>
<span id="cb25-29"><a href="#cb25-29"></a>dat_lasso <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Development"</span>, <span class="fu">nrow</span>(development)), <span class="fu">rep</span>(<span class="st">"Validation"</span>, <span class="fu">nrow</span>(validation))),</span>
<span id="cb25-30"><a href="#cb25-30"></a>                    <span class="at">preds =</span> <span class="fu">c</span>(<span class="fu">preds</span>(fit_lasso, x, y), <span class="fu">preds</span>(fit_lasso, x_val, y_val)),</span>
<span id="cb25-31"><a href="#cb25-31"></a>                    <span class="at">obs =</span> <span class="fu">c</span>(y, y_val))<span class="sc">%&gt;%</span></span>
<span id="cb25-32"><a href="#cb25-32"></a>    <span class="co"># Add indicator</span></span>
<span id="cb25-33"><a href="#cb25-33"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"LASSO"</span>)</span>
<span id="cb25-34"><a href="#cb25-34"></a></span>
<span id="cb25-35"><a href="#cb25-35"></a><span class="co"># Elastic net model</span></span>
<span id="cb25-36"><a href="#cb25-36"></a>dat_elnet <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"Development"</span>, <span class="fu">nrow</span>(development)), <span class="fu">rep</span>(<span class="st">"Validation"</span>, <span class="fu">nrow</span>(validation))),</span>
<span id="cb25-37"><a href="#cb25-37"></a>                    <span class="at">preds =</span> <span class="fu">c</span>(<span class="fu">preds</span>(fit_elnet, x, y), <span class="fu">preds</span>(fit_elnet, x_val, y_val)),</span>
<span id="cb25-38"><a href="#cb25-38"></a>                    <span class="at">obs =</span> <span class="fu">c</span>(y, y_val))<span class="sc">%&gt;%</span></span>
<span id="cb25-39"><a href="#cb25-39"></a>    <span class="co"># Add indicator</span></span>
<span id="cb25-40"><a href="#cb25-40"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"Elastic net"</span>)</span>
<span id="cb25-41"><a href="#cb25-41"></a></span>
<span id="cb25-42"><a href="#cb25-42"></a><span class="co"># Combine all data</span></span>
<span id="cb25-43"><a href="#cb25-43"></a>dat_cal <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_standard,</span>
<span id="cb25-44"><a href="#cb25-44"></a>                 dat_ridge,</span>
<span id="cb25-45"><a href="#cb25-45"></a>                 dat_lasso,</span>
<span id="cb25-46"><a href="#cb25-46"></a>                 dat_elnet) <span class="sc">%&gt;%</span></span>
<span id="cb25-47"><a href="#cb25-47"></a>    <span class="co"># Change models to factor</span></span>
<span id="cb25-48"><a href="#cb25-48"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="fu">factor</span>(model, <span class="at">levels =</span> <span class="fu">c</span>(<span class="st">"Standard"</span>, <span class="st">"Ridge"</span>, <span class="st">"LASSO"</span>, <span class="st">"Elastic net"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="validate-models" class="level3" data-number="4.5.2">
<h3 data-number="4.5.2" class="anchored" data-anchor-id="validate-models"><span class="header-section-number">4.5.2</span> Validate models</h3>
<p>Now we can determine how the different models performed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1"></a><span class="co"># Calculate C-statistics</span></span>
<span id="cb26-2"><a href="#cb26-2"></a>cstats <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"standard"</span>, <span class="st">"ridge"</span>, <span class="st">"lasso"</span>, <span class="st">"elastic net"</span>), <span class="dv">2</span>),</span>
<span id="cb26-3"><a href="#cb26-3"></a>                 <span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"development"</span>, <span class="dv">4</span>), <span class="fu">rep</span>(<span class="st">"validation"</span>, <span class="dv">4</span>)),</span>
<span id="cb26-4"><a href="#cb26-4"></a>                 <span class="at">cstat =</span> <span class="fu">c</span>(<span class="fu">cstat</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development), <span class="fu">cstat</span>(fit_ridge, x, y), </span>
<span id="cb26-5"><a href="#cb26-5"></a>                           <span class="fu">cstat</span>(fit_lasso, x, y), <span class="fu">cstat</span>(fit_elnet, x, y),</span>
<span id="cb26-6"><a href="#cb26-6"></a>                           <span class="fu">cstat</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation), <span class="fu">cstat</span>(fit_ridge, x_val, y_val), </span>
<span id="cb26-7"><a href="#cb26-7"></a>                           <span class="fu">cstat</span>(fit_lasso, x_val, y_val), <span class="fu">cstat</span>(fit_elnet, x_val, y_val)))</span>
<span id="cb26-8"><a href="#cb26-8"></a></span>
<span id="cb26-9"><a href="#cb26-9"></a><span class="co"># Pivot data</span></span>
<span id="cb26-10"><a href="#cb26-10"></a>cstats <span class="sc">%&lt;&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cohort, <span class="at">values_from =</span> cstat)</span>
<span id="cb26-11"><a href="#cb26-11"></a></span>
<span id="cb26-12"><a href="#cb26-12"></a><span class="co"># Print results</span></span>
<span id="cb26-13"><a href="#cb26-13"></a><span class="fu">kable</span>(cstats)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">development</th>
<th style="text-align: right;">validation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">standard</td>
<td style="text-align: right;">0.7385586</td>
<td style="text-align: right;">0.7011399</td>
</tr>
<tr class="even">
<td style="text-align: left;">ridge</td>
<td style="text-align: right;">0.7380766</td>
<td style="text-align: right;">0.7012724</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lasso</td>
<td style="text-align: right;">0.7367324</td>
<td style="text-align: right;">0.7026008</td>
</tr>
<tr class="even">
<td style="text-align: left;">elastic net</td>
<td style="text-align: right;">0.7375632</td>
<td style="text-align: right;">0.7020608</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>Let’s also look at the calibration metrics</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1"></a><span class="co"># Calculate C-statistics</span></span>
<span id="cb27-2"><a href="#cb27-2"></a>calibm <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">model =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"standard"</span>, <span class="st">"ridge"</span>, <span class="st">"lasso"</span>, <span class="st">"elastic net"</span>), <span class="dv">2</span>),</span>
<span id="cb27-3"><a href="#cb27-3"></a>                 <span class="at">cohort =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">"development"</span>, <span class="dv">4</span>), <span class="fu">rep</span>(<span class="st">"validation"</span>, <span class="dv">4</span>)),</span>
<span id="cb27-4"><a href="#cb27-4"></a>                 <span class="at">intercept =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_ridge, x, y)[[<span class="dv">1</span>]], </span>
<span id="cb27-5"><a href="#cb27-5"></a>                               <span class="fu">calmetrics</span>(fit_lasso, x, y)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_elnet, x, y)[[<span class="dv">1</span>]],</span>
<span id="cb27-6"><a href="#cb27-6"></a>                               <span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_ridge, x_val, y_val)[[<span class="dv">1</span>]], </span>
<span id="cb27-7"><a href="#cb27-7"></a>                               <span class="fu">calmetrics</span>(fit_lasso, x_val, y_val)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_elnet, x_val, y_val)[[<span class="dv">1</span>]]),</span>
<span id="cb27-8"><a href="#cb27-8"></a>                 <span class="at">slope =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_ridge, x, y)[[<span class="dv">2</span>]], </span>
<span id="cb27-9"><a href="#cb27-9"></a>                           <span class="fu">calmetrics</span>(fit_lasso, x, y)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_elnet, x, y)[[<span class="dv">2</span>]],</span>
<span id="cb27-10"><a href="#cb27-10"></a>                           <span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_ridge, x_val, y_val)[[<span class="dv">2</span>]], </span>
<span id="cb27-11"><a href="#cb27-11"></a>                           <span class="fu">calmetrics</span>(fit_lasso, x_val, y_val)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_elnet, x_val, y_val)[[<span class="dv">2</span>]]))</span>
<span id="cb27-12"><a href="#cb27-12"></a></span>
<span id="cb27-13"><a href="#cb27-13"></a><span class="co"># Pivot data</span></span>
<span id="cb27-14"><a href="#cb27-14"></a>calibm <span class="sc">%&lt;&gt;%</span> <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> cohort, <span class="at">values_from =</span> <span class="fu">c</span>(intercept, slope))</span>
<span id="cb27-15"><a href="#cb27-15"></a></span>
<span id="cb27-16"><a href="#cb27-16"></a><span class="co"># Print calibration metrics </span></span>
<span id="cb27-17"><a href="#cb27-17"></a><span class="fu">kable</span>(calibm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="caption-top table table-sm table-striped small">
<colgroup>
<col style="width: 13%">
<col style="width: 24%">
<col style="width: 23%">
<col style="width: 20%">
<col style="width: 18%">
</colgroup>
<thead>
<tr class="header">
<th style="text-align: left;">model</th>
<th style="text-align: right;">intercept_development</th>
<th style="text-align: right;">intercept_validation</th>
<th style="text-align: right;">slope_development</th>
<th style="text-align: right;">slope_validation</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">standard</td>
<td style="text-align: right;">0.000</td>
<td style="text-align: right;">0.154</td>
<td style="text-align: right;">1.000</td>
<td style="text-align: right;">0.875</td>
</tr>
<tr class="even">
<td style="text-align: left;">ridge</td>
<td style="text-align: right;">0.046</td>
<td style="text-align: right;">0.199</td>
<td style="text-align: right;">1.096</td>
<td style="text-align: right;">0.959</td>
</tr>
<tr class="odd">
<td style="text-align: left;">lasso</td>
<td style="text-align: right;">0.041</td>
<td style="text-align: right;">0.219</td>
<td style="text-align: right;">1.086</td>
<td style="text-align: right;">0.974</td>
</tr>
<tr class="even">
<td style="text-align: left;">elastic net</td>
<td style="text-align: right;">0.031</td>
<td style="text-align: right;">0.198</td>
<td style="text-align: right;">1.065</td>
<td style="text-align: right;">0.945</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>We can also look at the calibration plots:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Create calibration plots for each model</span></span>
<span id="cb28-2"><a href="#cb28-2"></a><span class="fu">ggplot</span>(dat_cal, <span class="at">mapping =</span> <span class="fu">aes</span>(<span class="at">x =</span> preds, <span class="at">y =</span> obs, <span class="at">colour =</span> cohort)) <span class="sc">+</span>               </span>
<span id="cb28-3"><a href="#cb28-3"></a>    <span class="co"># Geometries</span></span>
<span id="cb28-4"><a href="#cb28-4"></a>    <span class="fu">geom_abline</span>(<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">colour =</span> <span class="st">"black"</span>, <span class="at">alpha =</span> <span class="fl">0.33</span>) <span class="sc">+</span>   </span>
<span id="cb28-5"><a href="#cb28-5"></a>    <span class="fu">geom_point</span>(<span class="at">alpha =</span> <span class="fl">0.33</span>) <span class="sc">+</span>  </span>
<span id="cb28-6"><a href="#cb28-6"></a>    <span class="fu">geom_smooth</span>(<span class="at">colour =</span> <span class="st">"#785EF0"</span>, <span class="at">fill =</span> <span class="st">"#785EF0"</span>, <span class="at">method =</span> <span class="st">"loess"</span>, <span class="at">formula =</span> <span class="st">"y ~ x"</span>) <span class="sc">+</span>  </span>
<span id="cb28-7"><a href="#cb28-7"></a>    <span class="co"># Scaling</span></span>
<span id="cb28-8"><a href="#cb28-8"></a>    <span class="fu">scale_colour_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"#648FFF"</span>, <span class="st">"#FFB000"</span>), <span class="at">aesthetics =</span> <span class="fu">c</span>(<span class="st">"fill"</span>, <span class="st">"colour"</span>)) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9"></a>    <span class="co"># Labels                              </span></span>
<span id="cb28-10"><a href="#cb28-10"></a>    <span class="fu">xlab</span>(<span class="st">"Predicted probability"</span>) <span class="sc">+</span>            </span>
<span id="cb28-11"><a href="#cb28-11"></a>    <span class="fu">ylab</span>(<span class="st">"Observed probability"</span>) <span class="sc">+</span></span>
<span id="cb28-12"><a href="#cb28-12"></a>    <span class="co"># Transformations</span></span>
<span id="cb28-13"><a href="#cb28-13"></a>    <span class="fu">coord_cartesian</span>(<span class="at">xlim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb28-14"><a href="#cb28-14"></a>    <span class="fu">facet_grid</span>(<span class="at">rows =</span> <span class="fu">vars</span>(model), <span class="at">cols =</span> <span class="fu">vars</span>(cohort)) <span class="sc">+</span></span>
<span id="cb28-15"><a href="#cb28-15"></a>    <span class="co"># Aesthetics                            </span></span>
<span id="cb28-16"><a href="#cb28-16"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb28-17"><a href="#cb28-17"></a>    <span class="fu">theme</span>(<span class="at">legend.title =</span> <span class="fu">element_blank</span>(),</span>
<span id="cb28-18"><a href="#cb28-18"></a>          <span class="at">legend.position =</span> <span class="st">"bottom"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pint_prd2_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What we see is that (although small for the C-statistics), the standard model performs better in the development data, but worse in the validation data. Note however that this does not have to be the case: <a href="https://doi.org/10.1177/0962280220921415">van Calster <em>et al.</em></a>.</p>
</section>
</section>
</section>
<section id="bootstrap-based-uniform-shrinkage" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Bootstrap-based uniform shrinkage</h1>
<p>The shrinkage methods we just saw work by adding a penalty to the maximum likelihood estimator. A different aprpoach is bootstrap-based uniform shrinkage, which calculates a shrinkage factor and uses this to penalize the estimated regression coefficients (instead of penalizing the estimator that estimates the coefficients). This is also the method used in the <code>{rms}</code> package as seen in the first practical.</p>
<section id="development" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="development"><span class="header-section-number">5.1</span> Development</h2>
<p>In short, we develop the prediction model on our full development data. Then, we bootstrap the data <span class="math inline">\(B\)</span> times and redevelop the model in each bootstrap sample <span class="math inline">\(b\)</span>. Each redeveloped model is applied to the development data and a calibration slope is calculated. Then, the shrinkage factor <span class="math inline">\(s\)</span> equals the average calibration slope among all bootstrap samples. The final regression coefficients are then calculated as <span class="math inline">\(\hat{\beta}_{j,shrunk} = \hat{\beta}_j * s\)</span>.</p>
<p>We already developed our standard model. For the bootstrapping, we can do:</p>
<div class="cell">
<div class="sourceCode cell-code" id="annotated-cell-21"><pre class="sourceCode numberSource r code-annotation-code number-lines code-with-copy code-annotated"><code class="sourceCode r"><span id="annotated-cell-21-1"><a href="#annotated-cell-21-1"></a><span class="co"># Specify number of bootstraps</span></span>
<span id="annotated-cell-21-2"><a href="#annotated-cell-21-2"></a>b <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="annotated-cell-21-3"><a href="#annotated-cell-21-3"></a></span>
<span id="annotated-cell-21-4"><a href="#annotated-cell-21-4"></a><span class="co"># Start bootstrapping procedure</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="1" onclick="event.preventDefault();">1</a><span id="annotated-cell-21-5" class="code-annotation-target"><a href="#annotated-cell-21-5"></a>s <span class="ot">&lt;-</span> <span class="fu">sapply</span>(<span class="dv">1</span><span class="sc">:</span>b, \(x){</span>
<span id="annotated-cell-21-6"><a href="#annotated-cell-21-6"></a>    <span class="co"># Set seed based on bootstrap iteration</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="2" onclick="event.preventDefault();">2</a><span id="annotated-cell-21-7" class="code-annotation-target"><a href="#annotated-cell-21-7"></a>    <span class="fu">set.seed</span>(x)</span>
<span id="annotated-cell-21-8"><a href="#annotated-cell-21-8"></a>    </span>
<span id="annotated-cell-21-9"><a href="#annotated-cell-21-9"></a>    <span class="co"># Randomly sample data with replacement</span></span>
<span id="annotated-cell-21-10"><a href="#annotated-cell-21-10"></a>    dat_smp <span class="ot">&lt;-</span> <span class="fu">slice_sample</span>(development,  </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="3" onclick="event.preventDefault();">3</a><span id="annotated-cell-21-11" class="code-annotation-target"><a href="#annotated-cell-21-11"></a>                            <span class="at">n =</span> <span class="fu">nrow</span>(development),</span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="4" onclick="event.preventDefault();">4</a><span id="annotated-cell-21-12" class="code-annotation-target"><a href="#annotated-cell-21-12"></a>                            <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="annotated-cell-21-13"><a href="#annotated-cell-21-13"></a>    </span>
<span id="annotated-cell-21-14"><a href="#annotated-cell-21-14"></a>    <span class="co"># Redevelop model</span></span>
<span id="annotated-cell-21-15"><a href="#annotated-cell-21-15"></a>    fit_smp <span class="ot">&lt;-</span> <span class="fu">glm</span>(d.unfav <span class="sc">~</span>                                        </span>
<span id="annotated-cell-21-16"><a href="#annotated-cell-21-16"></a>                       age <span class="sc">+</span>     </span>
<span id="annotated-cell-21-17"><a href="#annotated-cell-21-17"></a>                       d.sysbpt <span class="sc">+</span></span>
<span id="annotated-cell-21-18"><a href="#annotated-cell-21-18"></a>                       pupil.i <span class="sc">+</span></span>
<span id="annotated-cell-21-19"><a href="#annotated-cell-21-19"></a>                       cause, </span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="5" onclick="event.preventDefault();">5</a><span id="annotated-cell-21-20" class="code-annotation-target"><a href="#annotated-cell-21-20"></a>                   <span class="at">data =</span> dat_smp, <span class="at">family =</span> binomial)</span>
<span id="annotated-cell-21-21"><a href="#annotated-cell-21-21"></a>    </span>
<span id="annotated-cell-21-22"><a href="#annotated-cell-21-22"></a>    <span class="co"># Get linear predictors</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="6" onclick="event.preventDefault();">6</a><span id="annotated-cell-21-23" class="code-annotation-target"><a href="#annotated-cell-21-23"></a>    development[[<span class="st">"lps"</span>]] <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit_smp, <span class="at">newdata =</span> development)</span>
<span id="annotated-cell-21-24"><a href="#annotated-cell-21-24"></a>    </span>
<span id="annotated-cell-21-25"><a href="#annotated-cell-21-25"></a>    <span class="co"># Calculate calibration slope</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="7" onclick="event.preventDefault();">7</a><span id="annotated-cell-21-26" class="code-annotation-target"><a href="#annotated-cell-21-26"></a>    slope <span class="ot">&lt;-</span> <span class="fu">glm</span>(d.unfav <span class="sc">~</span> lps, <span class="at">data =</span> development, <span class="at">family =</span> binomial)[[<span class="st">"coefficients"</span>]][[<span class="st">"lps"</span>]]</span>
<span id="annotated-cell-21-27"><a href="#annotated-cell-21-27"></a>    </span>
<span id="annotated-cell-21-28"><a href="#annotated-cell-21-28"></a>    <span class="co"># Return slope</span></span>
<span id="annotated-cell-21-29"><a href="#annotated-cell-21-29"></a>    <span class="fu">return</span>(slope)</span>
<span id="annotated-cell-21-30"><a href="#annotated-cell-21-30"></a>}) <span class="sc">%&gt;%</span></span>
<span id="annotated-cell-21-31"><a href="#annotated-cell-21-31"></a>    <span class="co"># Take mean</span></span>
<a class="code-annotation-anchor" data-target-cell="annotated-cell-21" data-target-annotation="8" onclick="event.preventDefault();">8</a><span id="annotated-cell-21-32" class="code-annotation-target"><a href="#annotated-cell-21-32"></a>    <span class="fu">mean</span>()</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-annotation">
<dl class="code-annotation-container-grid">
<dt data-target-cell="annotated-cell-21" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="5" data-code-annotation="1">Start bootstrapping procedure, where we iterate 500 times (b) and call a function (<code>\(x)</code>).</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="7" data-code-annotation="2">Set a seed for the random process each bootstrap (the sampling)</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="11" data-code-annotation="3">Sample as many individuals as our data contains.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="12" data-code-annotation="4">Sample is with replacement, meaning the same individual can be sampled multiple times.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="20" data-code-annotation="5">Redevelop the model on the sampled data.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="23" data-code-annotation="6">Make predictions on the development data using the sample-based prediction model.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="26" data-code-annotation="7">Calculate the slope.</span>
</dd>
<dt data-target-cell="annotated-cell-21" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-21" data-code-lines="32" data-code-annotation="8">Take the mean of the slopes from all bootstraps.</span>
</dd>
</dl>
</div>
</div>
<p>Now that we have <span class="math inline">\(s\)</span>, we can multiply it with the coefficients of the standard model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1"></a><span class="co"># Take coefficients from standard model and multiply by s</span></span>
<span id="cb29-2"><a href="#cb29-2"></a>coefs <span class="ot">&lt;-</span> fit[[<span class="st">"coefficients"</span>]] <span class="sc">*</span> s</span>
<span id="cb29-3"><a href="#cb29-3"></a></span>
<span id="cb29-4"><a href="#cb29-4"></a><span class="co"># Compare coefficients</span></span>
<span id="cb29-5"><a href="#cb29-5"></a><span class="fu">data.frame</span>(<span class="at">standard =</span> fit[[<span class="st">"coefficients"</span>]],</span>
<span id="cb29-6"><a href="#cb29-6"></a>           <span class="at">bu =</span> coefs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               standard           bu
(Intercept)                -1.382712131 -1.323924298
age                         0.037291271  0.035705784
d.sysbpt                   -0.008378515 -0.008022292
pupil.ino reactive pupils   1.836702419  1.758612589
pupil.ione reactive         0.834370082  0.798895735
causedomestic/fall          0.296242006  0.283646886
causeMotorbike             -0.019630030 -0.018795434
causeother                  0.483428921  0.462875302
causeRoad traffic accident  0.266325399  0.255002223</code></pre>
</div>
</div>
</section>
<section id="validation" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="validation"><span class="header-section-number">5.2</span> Validation</h2>
<p>Prior to validating the model, we will wrangle the existing model fit a bit so that it contains the information relevant for validating the model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1"></a><span class="co"># Update fit with new coefficients</span></span>
<span id="cb31-2"><a href="#cb31-2"></a>fit_bu <span class="ot">&lt;-</span> fit</span>
<span id="cb31-3"><a href="#cb31-3"></a></span>
<span id="cb31-4"><a href="#cb31-4"></a><span class="co"># Add updated coefficients</span></span>
<span id="cb31-5"><a href="#cb31-5"></a>fit_bu[[<span class="st">"coefficients"</span>]] <span class="ot">&lt;-</span> coefs</span>
<span id="cb31-6"><a href="#cb31-6"></a></span>
<span id="cb31-7"><a href="#cb31-7"></a><span class="co"># Recalculate linear predictors</span></span>
<span id="cb31-8"><a href="#cb31-8"></a><span class="co"># We perform matrix multiplication of each individual's values with the coefficients minus the intercept (as the matrix x does not contain this). Afterwards, we add the intercept again.</span></span>
<span id="cb31-9"><a href="#cb31-9"></a>fit_bu[[<span class="st">"linear.predictors"</span>]] <span class="ot">&lt;-</span> x <span class="sc">%*%</span> <span class="fu">as.matrix</span>(fit_bu[[<span class="st">"coefficients"</span>]])[<span class="dv">2</span><span class="sc">:</span><span class="dv">9</span>] <span class="sc">+</span> fit_bu[[<span class="st">"coefficients"</span>]][[<span class="dv">1</span>]]</span>
<span id="cb31-10"><a href="#cb31-10"></a></span>
<span id="cb31-11"><a href="#cb31-11"></a><span class="co"># Recalculate the predicted risk</span></span>
<span id="cb31-12"><a href="#cb31-12"></a>fit_bu[[<span class="st">"fitted.values"</span>]] <span class="ot">&lt;-</span> <span class="fu">exp</span>(fit_bu[[<span class="st">"linear.predictors"</span>]]) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(fit_bu[[<span class="st">"linear.predictors"</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This may seem like a bit of a hassle, especially since the <code>{rms}</code> package already implements this. On the other hand, as discussed in the previous practical, using the <code>{rms}</code> package might have its downsides.</p>
<p>Now let’s see the validation metrics:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource r number-lines code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1"></a><span class="fu">tibble</span>(<span class="at">model =</span> <span class="fu">c</span>(<span class="st">"standard"</span>, <span class="st">"BU"</span>),</span>
<span id="cb32-2"><a href="#cb32-2"></a>       <span class="at">cstat_dev =</span> <span class="fu">c</span>(<span class="fu">cstat</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development), <span class="fu">cstat</span>(fit_bu, <span class="at">y =</span> y, <span class="at">df =</span> development)),</span>
<span id="cb32-3"><a href="#cb32-3"></a>       <span class="at">cstat_val =</span> <span class="fu">c</span>(<span class="fu">cstat</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation), <span class="fu">cstat</span>(fit_bu, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)),</span>
<span id="cb32-4"><a href="#cb32-4"></a>       <span class="at">intercept_dev =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_bu, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">1</span>]]),</span>
<span id="cb32-5"><a href="#cb32-5"></a>       <span class="at">intercept_val =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">1</span>]], <span class="fu">calmetrics</span>(fit_bu, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">1</span>]]),</span>
<span id="cb32-6"><a href="#cb32-6"></a>       <span class="at">slope_dev =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_bu, <span class="at">y =</span> y, <span class="at">df =</span> development)[[<span class="dv">2</span>]]),</span>
<span id="cb32-7"><a href="#cb32-7"></a>       <span class="at">slope_val =</span> <span class="fu">c</span>(<span class="fu">calmetrics</span>(fit, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">2</span>]], <span class="fu">calmetrics</span>(fit_bu, <span class="at">y =</span> y_val, <span class="at">df =</span> validation)[[<span class="dv">2</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 2 × 7
  model    cstat_dev cstat_val intercept_dev intercept_val slope_dev slope_val
  &lt;chr&gt;        &lt;dbl&gt;     &lt;dbl&gt;         &lt;dbl&gt;         &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;
1 standard     0.739     0.701             0         0.154      1        0.875
2 BU           0.739     0.701             0         0.154      1.04     0.914</code></pre>
</div>
</div>
<p>We see that the C-statistics remained the same, likely because the shift in final predictions was small. However, the calibration of the standard model was better than the bootstrapped model in the development data, but worse in the validation data, as expected.</p>
</section>
</section>
<section id="final-words" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Final words</h1>
<p>We now discussed different shrinkage methods and have seen how to implement these. There are other methods available for shrinkage and these methods can also be applied to regression models other than logistic regression, but you are now familiar with the implementation of some of the most popular approaches.</p>
</section>
<section id="postscript" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Postscript</h1>
<p>This practical was developed on:</p>
<div class="cell">
<div class="cell-output cell-output-stdout">
<pre><code>R version 4.4.1 (2024-06-14 ucrt)
Platform: x86_64-w64-mingw32/x64
Running under: Windows 11 x64 (build 22631)

Matrix products: default


locale:
[1] LC_COLLATE=English_United Kingdom.utf8 
[2] LC_CTYPE=English_United Kingdom.utf8   
[3] LC_MONETARY=English_United Kingdom.utf8
[4] LC_NUMERIC=C                           
[5] LC_TIME=English_United Kingdom.utf8    

time zone: Europe/Amsterdam
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] patchwork_1.2.0 ggplot2_3.5.1   knitr_1.48      pROC_1.18.5    
 [5] glmnet_4.1-8    Matrix_1.7-0    rio_1.2.1       tidyr_1.3.1    
 [9] magrittr_2.0.3  dplyr_1.1.4    

loaded via a namespace (and not attached):
 [1] utf8_1.2.4        generics_0.1.3    shape_1.4.6.1     lattice_0.22-6   
 [5] digest_0.6.36     evaluate_0.24.0   grid_4.4.1        iterators_1.0.14 
 [9] fastmap_1.2.0     R.oo_1.26.0       foreach_1.5.2     plyr_1.8.9       
[13] jsonlite_1.8.8    R.utils_2.12.3    survival_3.6-4    mgcv_1.9-1       
[17] purrr_1.0.2       fansi_1.0.6       scales_1.3.0      codetools_0.2-20 
[21] cli_3.6.3         rlang_1.1.4       R.methodsS3_1.8.2 munsell_0.5.1    
[25] splines_4.4.1     withr_3.0.1       yaml_2.3.10       tools_4.4.1      
[29] colorspace_2.1-1  pacman_0.5.1      vctrs_0.6.5       R6_2.5.1         
[33] lifecycle_1.0.4   htmlwidgets_1.6.4 pkgconfig_2.0.3   pillar_1.9.0     
[37] gtable_0.3.5      data.table_1.15.4 glue_1.7.0        Rcpp_1.0.13      
[41] xfun_0.46         tibble_3.2.1      tidyselect_1.2.1  farver_2.1.2     
[45] nlme_3.1-164      htmltools_0.5.8.1 labeling_0.4.3    rmarkdown_2.27   
[49] compiler_4.4.1   </code></pre>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/rjjanse\.github\.io\/practicals\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>